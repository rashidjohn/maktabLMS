{% extends 'base.html' %}
{% block title %}{{ quiz.title }} - Maktab LMS{% endblock %}
{% block content %}

<style>
    /* --- ENTERPRISE LMS DESIGN SYSTEM --- */
    :root {
        --primary-deep: #1e3a8a;
        --primary-light: #3b82f6;
        --primary-soft: #eff6ff;
        --accent-danger: #ef4444;
        --danger-soft: #fef2f2;
        --bg-slate: #f8fafc;
        --surface-white: #ffffff;
        --text-dark: #0f172a;
        --text-muted: #64748b;
        --border-soft: #e2e8f0;
        --radius-xl: 20px;
        --radius-lg: 16px;
        --radius-md: 12px;
        --shadow-elevation: 0 10px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.02);
        --shadow-header: 0 4px 20px rgba(0, 0, 0, 0.06);
        --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        --font-mono: 'JetBrains Mono', 'Fira Code', ui-monospace, monospace;
    }

    body {
        background-color: var(--bg-slate) !important;
        font-family: 'Inter', system-ui, -apple-system, sans-serif;
    }

    /* --- STICKY HEADER REFINEMENT --- */
    .sticky-top.bg-white {
        background: rgba(255, 255, 255, 0.95) !important;
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border: none !important;
        border-radius: var(--radius-lg) !important;
        box-shadow: var(--shadow-header) !important;
        margin-top: 1rem;
        padding: 1.25rem 1.5rem !important;
        position: sticky;
        top: 20px;
        z-index: 1020;
    }

    /* Custom bottom gradient border replacing original border */
    .sticky-top.bg-white::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 4px;
        background: linear-gradient(90deg, var(--primary-deep), var(--primary-light));
        border-radius: 0 0 var(--radius-lg) var(--radius-lg);
    }

    .sticky-top h4.text-primary {
        color: var(--primary-deep) !important;
        font-weight: 800;
        letter-spacing: -0.02em;
        font-size: 1.4rem;
    }

    .sticky-top small.text-muted {
        font-size: 0.95rem;
        font-weight: 500;
    }

    /* --- TIMER ARCHITECTURE --- */
    .text-danger.bg-light {
        background: var(--danger-soft) !important;
        color: var(--accent-danger) !important;
        border: 1px solid #fecaca;
        font-family: var(--font-mono);
        letter-spacing: 1px;
        box-shadow: inset 0 2px 4px rgba(239, 68, 68, 0.05) !important;
        transition: var(--transition);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    @keyframes pulseWarning {
        0% { background: var(--danger-soft); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
        70% { background: #fee2e2; box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        100% { background: var(--danger-soft); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
    }

    .timer-warning {
        animation: pulseWarning 1.5s infinite;
        color: #b91c1c !important;
        border-color: #fca5a5 !important;
    }

    /* --- QUESTION CARDS --- */
    .card {
        border-radius: var(--radius-lg) !important;
        box-shadow: var(--shadow-elevation) !important;
        border: 1px solid rgba(226, 232, 240, 0.8) !important;
        background: var(--surface-white) !important;
        opacity: 0;
        animation: fadeUp 0.6s ease-out forwards;
    }

    .card-title.text-dark {
        color: var(--text-dark) !important;
        font-size: 1.2rem;
        line-height: 1.6;
        letter-spacing: -0.01em;
        padding-bottom: 1rem;
        border-bottom: 1px dashed var(--border-soft);
    }

    /* --- ANSWER SELECTION UX --- */
    .form-check.bg-light {
        background: #f8fafc !important;
        border-color: var(--border-soft) !important;
        transition: var(--transition) !important;
        border-radius: var(--radius-md) !important;
        margin-bottom: 0.75rem !important;
    }

    .form-check.bg-light:hover {
        background: #f1f5f9 !important;
        border-color: #cbd5e1 !important;
        transform: translateX(4px);
    }

    /* Styling the native radio input */
    .form-check-input {
        accent-color: var(--primary-deep) !important;
        box-shadow: none !important;
        transition: var(--transition);
    }

    /* Overriding original JS classes for premium active state */
    .form-check.bg-primary {
        background: var(--primary-soft) !important;
        border-color: var(--primary-light) !important;
        box-shadow: 0 0 0 1px var(--primary-light) !important;
        transform: translateX(6px) !important;
    }

    .form-check.bg-primary .form-check-label {
        color: var(--primary-deep) !important;
        font-weight: 600 !important;
    }

    /* --- SUBMIT ACTION --- */
    .btn-primary.rounded-pill {
        background: linear-gradient(135deg, var(--primary-deep) 0%, var(--primary-light) 100%) !important;
        border: none !important;
        box-shadow: 0 10px 20px -5px rgba(30, 58, 138, 0.4) !important;
        letter-spacing: 0.02em;
        text-transform: uppercase;
        font-size: 1.1rem !important;
        padding: 1.25rem !important;
        transition: var(--transition) !important;
    }

    .btn-primary.rounded-pill:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 25px -5px rgba(30, 58, 138, 0.5) !important;
        filter: brightness(1.05);
    }

    /* --- ANIMATIONS --- */
    @keyframes fadeUp {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
</style>

<div class="row mt-4">
    <div class="col-md-8 mx-auto">
        <div class="d-flex justify-content-between align-items-center bg-white p-3 rounded shadow-sm mb-4 sticky-top border-bottom border-primary border-3">
            <div>
                <h4 class="text-primary mb-0">{{ quiz.subject.name }}</h4>
                <small class="text-muted">{{ quiz.title }}</small>
            </div>
            <div class="text-danger fw-bold fs-3 bg-light px-4 py-2 rounded shadow-sm">
                ⏱️ <span id="timer">Yuklanmoqda...</span>
            </div>
        </div>
        <form id="quizForm" method="POST" action="{% url 'take_quiz' quiz.id %}">
            {% csrf_token %}
            {% for question in questions %}
            <div class="card mb-4 shadow-sm border-0">
                <div class="card-body p-4">
                    <h5 class="card-title fw-bold mb-4 text-dark">{{ forloop.counter }}. {{ question.text }}</h5>
                    <div class="answers-group">
                        {% for answer in question.answers.all %}
                        <div class="form-check mb-3 py-3 px-4 rounded bg-light border" style="cursor: pointer;">
                            <input class="form-check-input ms-0 me-3" type="radio" name="question_{{ question.id }}" id="ans_{{ answer.id }}" value="{{ answer.id }}" required style="transform: scale(1.3);">
                            <label class="form-check-label w-100 fw-medium text-dark" for="ans_{{ answer.id }}" style="cursor: pointer; font-size: 1.1rem;">
                                {{ answer.text }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
            {% endfor %}
            <button type="submit" class="btn btn-primary w-100 py-3 fw-bold fs-5 mb-5 shadow rounded-pill">Testni yakunlash</button>
        </form>
    </div>
</div>
<script>
    let timeRemaining = {{ quiz.duration_minutes }} * 60;
    const timerElement = document.getElementById('timer');
    const form = document.getElementById('quizForm');

    const interval = setInterval(function() {
        let minutes = Math.floor(timeRemaining / 60);
        let seconds = timeRemaining % 60;
        if (seconds < 10) seconds = "0" + seconds;
        if (minutes < 10) minutes = "0" + minutes;
        timerElement.innerText = minutes + ":" + seconds;
        timeRemaining--;

        if (timeRemaining < 0) {
            clearInterval(interval);
            timerElement.innerText = "00:00";
            form.submit();
        }
    }, 1000);

    document.querySelectorAll('.form-check').forEach(item => {
        item.addEventListener('click', event => {
            let parentGroup = item.closest('.answers-group');
            parentGroup.querySelectorAll('.form-check').forEach(div => {
                div.classList.remove('bg-primary', 'bg-opacity-10', 'border-primary');
            });
            item.classList.add('bg-primary', 'bg-opacity-10', 'border-primary');
            item.querySelector('input').checked = true;
        })
    });
</script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // 1. Staggered fade-up animation for questions to create a premium loading feel
        const questionCards = document.querySelectorAll('#quizForm .card');
        questionCards.forEach((card, index) => {
            card.style.animationDelay = `${index * 0.1}s`;
        });

        // 2. Timer Warning UX (Triggers pulse effect when < 1 minute remaining)
        const timerContainer = timerElement.parentElement;
        setInterval(() => {
            if (timerElement.innerText.startsWith('00:')) {
                timerContainer.classList.add('timer-warning');
            } else {
                timerContainer.classList.remove('timer-warning');
            }
        }, 1000);

        // 3. Smooth scroll to first unanswered question on submit attempt
        form.addEventListener('invalid', (e) => {
            e.preventDefault();
            const firstInvalid = form.querySelector(':invalid');
            if (firstInvalid) {
                const card = firstInvalid.closest('.card');
                card.scrollIntoView({ behavior: 'smooth', block: 'center' });
                // Visual shake feedback
                card.style.transform = 'translateX(10px)';
                setTimeout(() => card.style.transform = 'translateX(-10px)', 100);
                setTimeout(() => card.style.transform = 'translateX(10px)', 200);
                setTimeout(() => card.style.transform = 'translateX(0)', 300);
            }
        }, true);
    });
</script>
{% endblock %}